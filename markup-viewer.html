<!DOCTYPE HTML>
<html>
<head>
<title>Markup Vewer</title>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--<link rel="icon" href="favicon.ico" type="image/x-icon" />-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/commonmark/0.27.0/commonmark.min.js"></script>
<script>

/**
 * Main script
 */

window.onload = function() {
    var uri = getParameterByName("uri", window.location.search);
    if (uri) {
        updateMarkup(uri);
    } else {
        document.getElementById("markup").innerHTML
            = "Please specify 'uri' like below.<br>"
            + "<code>markup-viewer.html?uri=&lturi-of-a-markup-file&gt<code>";
    }
};

/**
 * Get a value of the first query matching argument 'name'.
 * @param  {string}  name Name of the query
 * @param  {string}  uri  URI to search the query from
 * @return {?string}      Parameter of the query, or null
 */
function getParameterByName(name, uri) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(uri);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

/**
 * Get contents of a markup file
 * @param {string} uri URI of the markup file
 */
function updateMarkup(uri) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            document.getElementById("markup").innerHTML = xhr.responseText;
            renderCommonmark();
        }
    };
    xhr.open("GET", uri, true);
    xhr.send();
}

/**
 * Parse and render the markup written in commonmark.
 * <https://github.com/jgm/commonmark.js>
 */
function renderCommonmark() {
    var reader = new commonmark.Parser();
    var parsed = reader.parse(document.getElementById("markup").innerHTML);
    var writer = new commonmark.HtmlRenderer();
    document.getElementById("markup").innerHTML = writer.render(parsed);
    replaceLink("md");
}

/**
 * Replace all links of markup files for AJAX requests
 * @param {string} extension Extension of target markup files
 */
function replaceLink(extension) {
    var links = document.getElementById("markup").getElementsByTagName("a");
    Array.prototype.forEach.call(links, function(l) {
        if (RegExp("\." + extension + "$").exec(l.pathname)) {
            l.onclick = function() {
                updateMarkup(l.href);
                history.pushState(null, document.title, l.href);
                return false;
            };
        }
    });
}

</script>
</head>
<body>
<div id="markup">Loading...</div>
</body>
</html>
